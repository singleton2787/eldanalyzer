<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELD Driver Log Analyzer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 2.5em; background: linear-gradient(45deg, #3498db, #9b59b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .upload-section { background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px; border: 2px dashed #dee2e6; text-align: center; transition: all 0.3s ease; }
        .upload-section:hover { border-color: #3498db; background: #e3f2fd; }
        .file-input { display: none; }
        .file-label { display: inline-block; padding: 15px 30px; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border-radius: 50px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .file-label:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); }
        .analyze-btn { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4); }
        .analyze-btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }
        .results { display: none; animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; }
        .metric-card:hover { transform: translateY(-5px); }
        .metric-value { font-size: 2.5em; font-weight: bold; margin-bottom: 10px; }
        .metric-label { color: #7f8c8d; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        .violation { color: #e74c3c; }
        .warning { color: #f39c12; }
        .good { color: #27ae60; }
        .section { background: white; margin-bottom: 30px; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.8em; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .violation-item { background: #fee; border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .violation-date { font-weight: bold; color: #e74c3c; margin-bottom: 5px; }
        .table-container { overflow-x: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: linear-gradient(45deg, #3498db, #2980b9); color: white; font-weight: bold; }
        tr:hover { background: #f8f9fa; }
        .progress-bar { height: 20px; background: #ecf0f1; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, #3498db, #2980b9); transition: width 0.3s ease; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .day-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .day-stat { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .day-stat-value { font-size: 1.5em; font-weight: bold; margin-bottom: 5px; }
        .day-stat-label { color: #7f8c8d; font-size: 0.9em; }
        .loading { text-align: center; padding: 50px; color: #7f8c8d; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .debug-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .debug-text { font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üöõ ELD Driver Log Analyzer</h1>
        
        <div class="upload-section">
            <h3>Upload ELD Log File</h3>
            <p>Select a <strong>text or PDF file</strong> containing ELD driver logs</p>
            <input type="file" id="fileInput" class="file-input" accept=".txt,.log,.pdf">
            <label for="fileInput" class="file-label">Choose File</label>
            <div id="fileName" style="margin-top: 10px; color: #7f8c8d;"></div>
            <button id="analyzeBtn" class="analyze-btn" disabled>Analyze Logs</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing driver logs...</p>
        </div>

        <div id="results" class="results">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div id="totalDays" class="metric-value">0</div>
                    <div class="metric-label">Days Analyzed</div>
                </div>
                <div class="metric-card">
                    <div id="totalMiles" class="metric-value">0</div>
                    <div class="metric-label">Total Miles</div>
                </div>
                <div class="metric-card">
                    <div id="totalViolations" class="metric-value violation">0</div>
                    <div class="metric-label">HOS Violations</div>
                </div>
                <div class="metric-card">
                    <div id="avgDailyMiles" class="metric-value">0</div>
                    <div class="metric-label">Avg Daily Miles</div>
                </div>
            </div>

            <div class="section">
                <h2>üö® Hours of Service Violations</h2>
                <div id="violationsList"></div>
            </div>

            <div class="section">
                <h2>üìä Daily Summary</h2>
                <div id="dailySummary"></div>
            </div>

            <div class="section">
                <h2>üïê Driving Patterns</h2>
                <div id="drivingPatterns"></div>
            </div>

            <div class="section">
                <h2>üìà Detailed Log Analysis</h2>
                <div class="table-container">
                    <table id="logTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Total Drive Time</th>
                                <th>On Duty Time</th>
                                <th>Miles</th>
                                <th>Violations</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>üîç Debug Information</h2>
                <div class="debug-section">
                    <h4>Extracted Text Preview:</h4>
                    <div id="debugText" class="debug-text"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ELDAnalyzer {
            constructor() {
                this.logData = [];
                this.violations = [];
                this.dailyStats = {};
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('fileInput').addEventListener('change', this.handleFileSelect.bind(this));
                document.getElementById('analyzeBtn').addEventListener('click', this.analyzeData.bind(this));
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('analyzeBtn').disabled = false;
                    this.file = file;
                }
            }

            async analyzeData() {
                if (!this.file) return;

                document.getElementById('loading').style.display = 'block';
                document.getElementById('results').style.display = 'none';

                try {
                    const text = await this.readFile(this.file);
                    console.log('Extracted text:', text.substring(0, 1000));
                    
                    // Show debug information
                    document.getElementById('debugText').textContent = text.substring(0, 1000) + '...';
                    
                    this.parseLogData(text);
                    this.calculateViolations();
                    this.generateDailyStats();
                    this.displayResults();
                } catch (error) {
                    console.error('Error analyzing data:', error);
                    alert('Error analyzing the log file. Please check the file format.');
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }

            async readFile(file) {
                return new Promise((resolve, reject) => {
                    if (file.type === "application/pdf" || file.name.endsWith('.pdf')) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            try {
                                const typedarray = new Uint8Array(e.target.result);
                                const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                                let textContent = '';
                                
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const txt = await page.getTextContent();
                                    
                                    // Better text extraction - preserve line breaks and spacing
                                    let pageText = '';
                                    let lastY = null;
                                    
                                    for (let j = 0; j < txt.items.length; j++) {
                                        const item = txt.items[j];
                                        
                                        // Add line break if Y position changed significantly
                                        if (lastY !== null && Math.abs(lastY - item.transform[5]) > 5) {
                                            pageText += '\n';
                                        }
                                        
                                        pageText += item.str;
                                        
                                        // Add space if the next item is far away horizontally
                                        if (j < txt.items.length - 1) {
                                            const nextItem = txt.items[j + 1];
                                            if (Math.abs(item.transform[4] + item.width - nextItem.transform[4]) > 5) {
                                                pageText += ' ';
                                            }
                                        }
                                        
                                        lastY = item.transform[5];
                                    }
                                    
                                    textContent += pageText + '\n';
                                }
                                
                                resolve(textContent);
                            } catch (err) {
                                reject(err);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                    } else {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    }
                });
            }

            parseLogData(text) {
                const lines = text.split('\n');
                this.logData = [];
                let currentDay = null;

                console.log('Parsing', lines.length, 'lines');

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    console.log('Processing line:', line);

                    // Look for date patterns - more flexible matching
                    const datePatterns = [
                        /Record\s+Date[:\s]*(\d{2}[-\/]\d{2}[-\/]\d{4})/i,
                        /Date[:\s]*(\d{2}[-\/]\d{2}[-\/]\d{4})/i,
                        /(\d{2}[-\/]\d{2}[-\/]\d{4})/,
                        /(\d{4}[-\/]\d{2}[-\/]\d{2})/
                    ];

                    let dateMatch = null;
                    for (const pattern of datePatterns) {
                        dateMatch = line.match(pattern);
                        if (dateMatch) break;
                    }

                    if (dateMatch) {
                        if (currentDay && currentDay.date) {
                            this.logData.push(currentDay);
                        }
                        
                        currentDay = {
                            date: dateMatch[1],
                            events: [],
                            totalHours: {
                                offDuty: 0,
                                sleeperBerth: 0,
                                driving: 0,
                                onDuty: 0
                            },
                            miles: 0,
                            startOdometer: 0,
                            endOdometer: 0
                        };
                        console.log('Found date:', dateMatch[1]);
                        continue;
                    }

                    if (!currentDay) continue;

                    // Look for odometer data - more flexible patterns
                    const odometerPatterns = [
                        /odometer[:\s]*(\d+)[-\s]*(\d+)/i,
                        /(\d+)\s*[-‚Äì]\s*(\d+)\s*miles?/i,
                        /start[:\s]*(\d+).*end[:\s]*(\d+)/i
                    ];

                    for (const pattern of odometerPatterns) {
                        const match = line.match(pattern);
                        if (match) {
                            currentDay.startOdometer = parseInt(match[1]);
                            currentDay.endOdometer = parseInt(match[2]);
                            currentDay.miles = currentDay.endOdometer - currentDay.startOdometer;
                            console.log('Found odometer:', match[1], '-', match[2], 'Miles:', currentDay.miles);
                            break;
                        }
                    }

                    // Look for time entries - more flexible patterns
                    const timePatterns = [
                        /(\d{1,2}):(\d{2}):(\d{2})\s+(.+?)\s+(\d+)\s+(\d+\.?\d*)\s+(\w+)/,
                        /(\d{1,2}):(\d{2})\s+(.+?)\s+(\w+)/,
                        /(\d{1,2}):(\d{2}):(\d{2})\s+(\w+)/
                    ];

                    for (const pattern of timePatterns) {
                        const match = line.match(pattern);
                        if (match) {
                            currentDay.events.push({
                                time: match[1] + ':' + match[2] + (match[3] ? ':' + match[3] : ':00'),
                                location: match[4] || 'Unknown',
                                odometer: match[5] ? parseInt(match[5]) : 0,
                                engineHours: match[6] ? parseFloat(match[6]) : 0,
                                status: match[7] || match[4] || 'Unknown',
                                fullLine: line
                            });
                            break;
                        }
                    }

                    // Look for daily totals - more flexible patterns
                    const hourPatterns = [
                        /(\d{1,2}):(\d{2}):(\d{2})/g,
                        /(\d{1,2}):(\d{2})/g
                    ];

                    for (const pattern of hourPatterns) {
                        const matches = [...line.matchAll(pattern)];
                        if (matches.length >= 4) {
                            currentDay.totalHours.offDuty = this.parseTimeToHours(matches[0][0]);
                            currentDay.totalHours.sleeperBerth = this.parseTimeToHours(matches[1][0]);
                            currentDay.totalHours.driving = this.parseTimeToHours(matches[2][0]);
                            currentDay.totalHours.onDuty = this.parseTimeToHours(matches[3][0]);
                            console.log('Found daily totals:', currentDay.totalHours);
                            break;
                        }
                    }

                    // Alternative: look for specific status keywords and try to extract hours
                    const statusHours = {
                        'off duty': 0,
                        'sleeper berth': 0,
                        'driving': 0,
                        'on duty': 0
                    };

                    for (const [status, _] of Object.entries(statusHours)) {
                        const statusRegex = new RegExp(status + '[:\\s]*([\\d\\.]+)\\s*h', 'i');
                        const match = line.match(statusRegex);
                        if (match) {
                            const hours = parseFloat(match[1]);
                            switch (status) {
                                case 'off duty':
                                    currentDay.totalHours.offDuty = hours;
                                    break;
                                case 'sleeper berth':
                                    currentDay.totalHours.sleeperBerth = hours;
                                    break;
                                case 'driving':
                                    currentDay.totalHours.driving = hours;
                                    break;
                                case 'on duty':
                                    currentDay.totalHours.onDuty = hours;
                                    break;
                            }
                        }
                    }
                }

                // Don't forget the last day
                if (currentDay && currentDay.date) {
                    this.logData.push(currentDay);
                }

                console.log('Parsed', this.logData.length, 'days of data');
                console.log('Sample data:', this.logData[0]);
            }

            parseTimeToHours(timeString) {
                if (!timeString) return 0;
                
                const parts = timeString.split(':');
                let hours = 0;
                
                if (parts.length >= 1) hours += parseInt(parts[0]) || 0;
                if (parts.length >= 2) hours += (parseInt(parts[1]) || 0) / 60;
                if (parts.length >= 3) hours += (parseInt(parts[2]) || 0) / 3600;
                
                return hours;
            }

            calculateViolations() {
                this.violations = [];

                for (const day of this.logData) {
                    const violations = [];

                    // 11-hour driving limit
                    if (day.totalHours.driving > 11) {
                        violations.push({
                            type: 'Driving Time Violation',
                            description: `Exceeded 11-hour driving limit: ${day.totalHours.driving.toFixed(2)} hours`,
                            severity: 'Critical'
                        });
                    }

                    // 14-hour on-duty limit
                    const totalOnDuty = day.totalHours.driving + day.totalHours.onDuty;
                    if (totalOnDuty > 14) {
                        violations.push({
                            type: '14-Hour Rule Violation',
                            description: `Exceeded 14-hour on-duty limit: ${totalOnDuty.toFixed(2)} hours`,
                            severity: 'Critical'
                        });
                    }

                    // 10-hour rest requirement
                    const totalRest = day.totalHours.offDuty + day.totalHours.sleeperBerth;
                    if (totalRest < 10) {
                        violations.push({
                            type: 'Insufficient Rest',
                            description: `Less than 10 hours of rest: ${totalRest.toFixed(2)} hours`,
                            severity: 'Warning'
                        });
                    }

                    if (violations.length > 0) {
                        this.violations.push({
                            date: day.date,
                            violations
                        });
                    }
                }
            }

            generateDailyStats() {
                if (this.logData.length === 0) {
                    this.dailyStats = {
                        totalDays: 0,
                        totalMiles: 0,
                        totalViolations: 0,
                        avgDrivingHours: 0,
                        avgOnDutyHours: 0,
                        avgMilesPerDay: 0
                    };
                    return;
                }

                const totalMiles = this.logData.reduce((sum, day) => sum + (day.miles || 0), 0);
                const totalDriving = this.logData.reduce((sum, day) => sum + (day.totalHours.driving || 0), 0);
                const totalOnDuty = this.logData.reduce((sum, day) => sum + (day.totalHours.onDuty || 0), 0);

                this.dailyStats = {
                    totalDays: this.logData.length,
                    totalMiles: totalMiles,
                    totalViolations: this.violations.length,
                    avgDrivingHours: totalDriving / this.logData.length,
                    avgOnDutyHours: totalOnDuty / this.logData.length,
                    avgMilesPerDay: totalMiles / this.logData.length
                };
            }

            displayResults() {
                // Update metrics
                document.getElementById('totalDays').textContent = this.dailyStats.totalDays;
                document.getElementById('totalMiles').textContent = this.dailyStats.totalMiles.toLocaleString();
                document.getElementById('totalViolations').textContent = this.dailyStats.totalViolations;
                document.getElementById('avgDailyMiles').textContent = Math.round(this.dailyStats.avgMilesPerDay || 0);

                // Display violations
                this.displayViolations();

                // Display daily summary
                this.displayDailySummary();

                // Display driving patterns
                this.displayDrivingPatterns();

                // Display detailed table
                this.displayDetailedTable();

                document.getElementById('results').style.display = 'block';
            }

            displayViolations() {
                const container = document.getElementById('violationsList');
                
                if (this.violations.length === 0) {
                    container.innerHTML = '<p style="color: #27ae60; font-weight: bold;">‚úÖ No violations detected</p>';
                    return;
                }

                let html = '';
                for (const dayViolation of this.violations) {
                    html += `<div class="violation-item">`;
                    html += `<div class="violation-date">${dayViolation.date}</div>`;
                    for (const violation of dayViolation.violations) {
                        html += `<div><strong>${violation.type}:</strong> ${violation.description}</div>`;
                    }
                    html += `</div>`;
                }
                container.innerHTML = html;
            }

            displayDailySummary() {
                const container = document.getElementById('dailySummary');
                let html = '';

                for (const day of this.logData) {
                    const hasViolations = this.violations.some(v => v.date === day.date);
                    const statusIcon = hasViolations ? 'üö®' : '‚úÖ';
                    const statusClass = hasViolations ? 'violation' : 'good';
                    
                    html += `
                        <div class="day-summary">
                            <div class="day-stat">
                                <div class="day-stat-value ${statusClass}">${statusIcon}</div>
                                <div class="day-stat-label">${day.date}</div>
                            </div>
                            <div class="day-stat">
                                <div class="day-stat-value">${(day.totalHours.driving || 0).toFixed(1)}h</div>
                                <div class="day-stat-label">Driving</div>
                            </div>
                            <div class="day-stat">
                                <div class="day-stat-value">${(day.totalHours.onDuty || 0).toFixed(1)}h</div>
                                <div class="day-stat-label">On Duty</div>
                            </div>
                            <div class="day-stat">
                                <div class="day-stat-value">${day.miles || 0}</div>
                                <div class="day-stat-label">Miles</div>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            }

            displayDrivingPatterns() {
                const container = document.getElementById('drivingPatterns');
                
                const avgDriving = this.dailyStats.avgDrivingHours || 0;
                const avgOnDuty = this.dailyStats.avgOnDutyHours || 0;
                const avgMiles = this.dailyStats.avgMilesPerDay || 0;
                const milesPerHour = avgDriving > 0 ? avgMiles / avgDriving : 0;

                container.innerHTML = `
                    <div class="day-summary">
                        <div class="day-stat">
                            <div class="day-stat-value">${avgDriving.toFixed(1)}h</div>
                            <div class="day-stat-label">Avg Driving/Day</div>
                        </div>
                        <div class="day-stat">
                            <div class="day-stat-value">${avgOnDuty.toFixed(1)}h</div>
                            <div class="day-stat-label">Avg On-Duty/Day</div>
                        </div>
                        <div class="day-stat">
                            <div class="day-stat-value">${avgMiles.toFixed(0)}</div>
                            <div class="day-stat-label">Avg Miles/Day</div>
                        </div>
                        <div class="day-stat">
                            <div class="day-stat-value">${milesPerHour.toFixed(1)}</div>
                            <div class="day-stat-label">Miles/Hour</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min((avgDriving / 11) * 100, 100)}%"></div>
                    </div>
                    <p style="text-align: center; margin-top: 10px;">Average driving time vs 11-hour limit</p>
                `;
            }

            displayDetailedTable() {
                const tbody = document.getElementById('logTableBody');
                let html = '';

                for (const day of this.logData) {
                    const hasViolations = this.violations.some(v => v.date === day.date);
                    const status = hasViolations ? 'üö® Violations' : '‚úÖ Compliant';
                    const statusClass = hasViolations ? 'violation' : 'good';
                    const violationCount = hasViolations ? this.violations.find(v => v.date === day.date).violations.length : 0;
                    
                    html += `
                        <tr>
                            <td>${day.date}</td>
                            <td>${(day.totalHours.driving || 0).toFixed(2)}h</td>
                            <td>${(day.total
